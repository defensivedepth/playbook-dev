name: Potential Credential Dumping Via LSASS Process Clone
id: 1500068
description: |
  Detects creation of an LSASS process clone, a technique used to bypass Windows Defender ATP credential-theft
  detection. The method leverages the PssCaptureSnapshot API to create a process snapshot of LSASS that can be
  dumped without triggering traditional ReadProcessMemory-based detection mechanisms. When PssCaptureSnapshot is
  called with PSS_CAPTURE_VA_CLONE and related flags, it creates a new lsass.exe process spawned from the original
  lsass.exe, enabling credential extraction from the snapshot without detection by statistical monitoring of LSASS
  memory reads. This technique has been observed in modified versions of credential dumping tools and represents
  a sophisticated evasion method.
type: detection
detection_id: c8da0dfd-4ed0-4b68-962d-13c9c884384e
detection_category: ''
detection_type: sigma
contributors:
- SecurityOnionSolutions
created: 2025-01-15
questions:
- question: What was the command line of the LSASS clone process created on this host?
  context: Identifies the execution parameters and context of the cloned LSASS process.
  range: +/-5m
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        ProcessGuid: '{event_data.process.entity_id}'
      condition: selection
    fields:
      - User
      - hostname
      - Image
      - CommandLine
      - ParentImage
- question: What process initiated the LSASS cloning operation via PssCaptureSnapshot?
  context: Reveals the credential dumping tool or script that performed the snapshot-based credential access.
  range: -15m
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        ProcessGuid: '{event_data.process.parent.entity_id}'
      condition: selection
    fields:
      - User
      - hostname
      - Image
      - CommandLine
      - Hashes
- question: Have other LSASS clone processes been created on this host?
  context: Determines if multiple credential dumping attempts occurred on the same system.
  range: +/-24h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        ParentImage|endswith: '\Windows\System32\lsass.exe'
        Image|endswith: '\Windows\System32\lsass.exe'
      filter:
        ProcessGuid: '{event_data.process.entity_id}'
      condition: selection and not filter
    fields:
      - User
      - Image
      - CommandLine
      - ParentImage
- question: Has this LSASS cloning technique been observed on other hosts in the environment?
  context: Reveals potential campaign-wide credential harvesting using this evasion technique.
  range: +/-24h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        ParentImage|endswith: '\Windows\System32\lsass.exe'
        Image|endswith: '\Windows\System32\lsass.exe'
      filter:
        hostname: '{event_data.host.name}'
      condition: selection and not filter
    fields:
      - hostname
      - User
      - Image
      - CommandLine
- question: What process activity occurred on this host in the 15 minutes before the LSASS clone was created?
  context: Identifies delivery mechanisms and preparatory activity preceding the credential access attempt.
  range: -15m
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - ParentImage
- question: Were any memory dump files created on the system around the time of LSASS cloning?
  context: Identifies the credential dump file written to disk after snapshot creation.
  range: +/-30m
  query: |
    aggregation: false
    logsource:
      category: file_event
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        TargetFilename|endswith:
          - '.dmp'
          - '.dump'
          - '.mdmp'
      condition: selection
    fields:
      - User
      - Image
      - TargetFilename
      - ProcessGuid
- question: Did the process that created the LSASS clone spawn any child processes afterward?
  context: Reveals post-credential-dump activity such as parsing tools or exfiltration utilities.
  range: +2h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        ParentProcessGuid: '{event_data.process.parent.entity_id}'
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - ParentImage
- question: What network connections occurred after the LSASS clone was created?
  context: Detects potential credential exfiltration or C2 communications following credential harvesting.
  range: +1h
  query: |
    aggregation: false
    logsource:
      category: network_connection
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
      condition: selection
    fields:
      - User
      - Image
      - DestinationIp
      - DestinationPort
      - ProcessGuid
- question: Were any files downloaded or written to disk in the 30 minutes before LSASS cloning?
  context: Identifies the delivery method for the credential dumping tool employing PssCaptureSnapshot technique.
  range: -30m
  query: |
    aggregation: false
    logsource:
      category: file_event
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        TargetFilename|endswith:
          - '.exe'
          - '.dll'
          - '.ps1'
          - '.zip'
      condition: selection
    fields:
      - User
      - Image
      - TargetFilename
      - ProcessGuid
- question: Are there any other credential dumping tools or suspicious executables present on this host?
  context: Identifies additional credential access tools that may be part of the same campaign.
  range: +/-24h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        Image|contains:
          - 'mimikatz'
          - 'procdump'
          - 'dumpert'
          - 'sqldumper'
          - 'nanodump'
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - Hashes
- question: Did the same user account create LSASS clones on other hosts in the environment?
  context: Tracks cross-host credential harvesting activity by the same account.
  range: +/-24h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        User: '{event_data.user.name}'
        ParentImage|endswith: '\Windows\System32\lsass.exe'
        Image|endswith: '\Windows\System32\lsass.exe'
      filter:
        hostname: '{event_data.host.name}'
      condition: selection and not filter
    fields:
      - hostname
      - Image
      - CommandLine
- question: Were there any PowerShell or scripting activity that might have invoked the PssCaptureSnapshot API?
  context: Detects script-based credential dumping leveraging PssCaptureSnapshot through .NET or COM interfaces.
  range: +/-1h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        Image|endswith:
          - '\powershell.exe'
          - '\pwsh.exe'
          - '\cscript.exe'
          - '\wscript.exe'
        CommandLine|contains:
          - 'PssCaptureSnapshot'
          - 'MiniDumpWriteDump'
          - 'System.Diagnostics'
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - ParentImage
- question: Are there signs of lateral movement or credential reuse after the LSASS cloning activity?
  context: Identifies attempts to leverage harvested credentials for lateral movement across the network.
  range: +2h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        Image|endswith:
          - '\psexec.exe'
          - '\wmic.exe'
          - '\net.exe'
          - '\net1.exe'
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - ParentImage

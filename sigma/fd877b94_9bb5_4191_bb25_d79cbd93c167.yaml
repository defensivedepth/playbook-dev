name: Dumping of Sensitive Hives Via Reg.EXE
id: 0
description: Detection of reg.exe being used to export or save sensitive Windows registry hives including SAM, SYSTEM, and SECURITY. These registry hives contain critical authentication data including password hashes and system secrets. While this activity can be legitimate for system backup or forensic purposes, it represents a common technique for credential harvesting.
type: detection
detection_id: fd877b94-9bb5-4191-bb25-d79cbd93c167
detection_category: Sigma
detection_type: host
contributors:
    - SecurityOnionSolutions
created: "2025-09-29"
questions:
    - question_id: PROC020
      question: What was the full reg.exe command executed including the save/export operation and target registry hive?
      context: Complete command line reveals the specific registry hive being accessed (SAM, SYSTEM, or SECURITY) and output destination for investigation context
      range: ""
      query:
        aggregation: false
        detection:
            condition: selection or parent
            parent:
                ParentProcessGuid: '{event_data.process.entity_id}'
            selection:
                ProcessGuid: '{event_data.process.entity_id}'
        fields:
            - Image
            - CommandLine
        logsource:
            category: process_creation
    - question_id: PROC013
      question: What process spawned the reg.exe command that accessed sensitive registry hives?
      context: Parent process identification helps determine if this registry access originated from legitimate administrative tools or unexpected sources
      range: +/-1h
      query:
        aggregation: false
        detection:
            condition: selection or parent
            parent:
                ParentProcessGuid: '{event_data.process.entity_id}'
            selection:
                ProcessGuid: '{event_data.process.entity_id}'
        fields:
            - Image
            - ParentImage
            - CommandLine
        logsource:
            category: process_creation
    - question_id: PROC021
      question: Did the reg.exe process spawn any additional processes after the registry hive operation?
      context: Subsequent processes may indicate follow-up activities with the exported registry data or additional credential harvesting attempts
      range: +5m
      query:
        aggregation: false
        detection:
            condition: selection or parent
            parent:
                ParentProcessGuid: '{event_data.process.entity_id}'
            selection:
                ProcessGuid: '{event_data.process.entity_id}'
        fields:
            - Image
            - CommandLine
        logsource:
            category: process_creation
    - question_id: PROC007
      question: Were there concurrent attempts to access LSASS, credential files, or other authentication stores?
      context: Coordinated access to multiple credential sources suggests systematic credential collection activities
      range: +/-30m
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                TargetImage|endswith: \lsass.exe
                event.outcome: failure
                hostname: '{event_data.host.name}'
        fields:
            - SourceImage
            - TargetImage
            - GrantedAccess
        logsource:
            category: process_access
    - question_id: USER001
      question: What user context and privileges were used to execute the reg.exe hive export operation?
      context: Registry hive access requires elevated privileges - understanding the user context helps validate legitimacy of administrative operations
      range: "0"
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                ProcessGuid: '{event_data.process.entity_id}'
                hostname: '{event_data.host.name}'
        fields:
            - ProcessGuid
            - ParentProcessGuid
            - Image
            - CommandLine
            - timestamp
        logsource:
            category: process_creation
    - question_id: REG008
      question: Which specific registry hives were targeted in the save/export operation (SAM, SYSTEM, SECURITY)?
      context: Different registry hives contain varying credential data - understanding the specific targets helps assess potential data exposure
      range: +/-1h
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                TargetObject|contains:
                    - \SAM\
                    - \SECURITY\
                    - \Credentials\
                event.outcome: failure
                hostname: '{event_data.host.name}'
        fields:
            - SourceImage
            - TargetImage
            - GrantedAccess
        logsource:
            category: process_access
    - question_id: HIST001
      question: What is the baseline frequency of registry hive exports for this user and system?
      context: Historical registry backup patterns help distinguish routine administrative maintenance from unusual credential access activities
      range: -90d
      query:
        aggregation: true
        detection:
            condition: selection
            selection:
                User: '{event_data.user.name}'
                hostname: '{event_data.host.name}'
        fields:
            - Image
            - User
            - CommandLine
        logsource:
            category: process_creation
    - question_id: HUNT004
      question: Have other systems performed similar registry hive exports using reg.exe in the past 24 hours?
      context: Network-wide registry export activity may indicate coordinated administrative operations or systematic credential collection campaigns
      range: -24h
      query:
        aggregation: false
        detection:
            condition: selection and not host_filter
            filter:
                hostname: '{event_data.host.name}'
            host_filter:
                hostname: '{event_data.host.name}'
            selection: null
        fields:
            - Image
            - CommandLine
            - User
            - ParentImage
            - ProcessGuid
        logsource:
            category: process_creation
    - question_id: NET002
      question: What DNS queries and network activity occurred around the time of the registry hive export?
      context: Network activity patterns help determine if exported registry data was prepared for exfiltration or used for legitimate backup purposes
      range: +/-30m
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                hostname: '{event_data.host.name}'
        fields:
            - dns.query.name
            - dns.resolved_ip
            - process.name
            - timestamp
        logsource:
            category: dns
    - question_id: UNI001
      question: What network connections were established before, during, or after the reg.exe registry export operation?
      context: Network connectivity context is essential for determining if registry hive data was accessed for local administrative purposes or potential data exfiltration
      range: +/-30m
      query:
        aggregation: false
        detection:
            condition: selection and filter
            filter:
                hostname: '{event_data.host.name}'
            selection: null
        fields:
            - process.name
            - process.pid
            - process.command_line
            - dst_ip
            - dst_port
        logsource:
            category: network
            product: windows
    - question_id: STAG001
      question: What other credential-related tools or processes executed from the same location as reg.exe?
      context: Co-located credential access tools may indicate a comprehensive credential harvesting toolkit or legitimate administrative utilities
      range: +/-20m
      query: tool_staging_analysis

name: HackTool - SharpUp PrivEsc Tool Execution
id: 1500063
description: |
  Detects the execution of SharpUp, a C# port of PowerUp functionality used for local privilege escalation enumeration. SharpUp performs automated checks for common Windows privilege escalation vectors including unquoted service paths, hijackable DLL paths, modifiable service binaries, weak service permissions, cached Group Policy Preference passwords, AlwaysInstallElevated registry settings, registry autologon credentials, and unattended installation files. While SharpUp has legitimate uses for security auditing and penetration testing in authorized environments, its execution in production environments typically indicates active privilege escalation attempts during post-exploitation phases of an attack.
type: detection
detection_id: c484e533-ee16-4a93-b6ac-f0ea4868b2f1
detection_category: ''
detection_type: sigma
contributors:
- SecurityOnionSolutions
created: 2025-10-15
questions:
- question: What was the full SharpUp command line executed on this host?
  context: Reveals the specific privilege escalation checks performed and whether audit mode was enabled.
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        ProcessGuid: '{event_data.process.entity_id}'
      condition: selection
    fields:
      - User
      - hostname
      - Image
      - CommandLine
      - ProcessId
- question: What process created the SharpUp execution?
  context: Identifies the delivery mechanism or parent process chain during post-exploitation.
  range: -15m
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        ProcessGuid: '{event_data.process.parent.entity_id}'
      condition: selection
    fields:
      - User
      - hostname
      - Image
      - CommandLine
      - ProcessId
- question: What processes were spawned by SharpUp after execution?
  context: Identifies privilege escalation attempts or exploitation of discovered vulnerabilities.
  range: +2h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        ParentProcessGuid: '{event_data.process.entity_id}'
      condition: selection
    fields:
      - User
      - hostname
      - Image
      - CommandLine
      - ProcessId
- question: Were any services with unquoted paths executed after SharpUp enumeration?
  context: SharpUp identifies unquoted service paths that can be exploited for privilege escalation by placing a binary in the path.
  range: +2h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        Image|contains: ' '
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - ParentImage
- question: Were any service modifications or installations performed after SharpUp execution?
  context: Detects exploitation of modifiable service binaries or weak service permissions identified by SharpUp.
  range: +2h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        Image|endswith: '\sc.exe'
        CommandLine|contains:
          - 'config'
          - 'create'
          - 'binPath'
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - ProcessId
- question: Were any DLL files placed in hijackable paths after SharpUp execution?
  context: SharpUp identifies DLL hijacking opportunities in user-writable PATH directories and service binary locations.
  range: +2h
  query: |
    aggregation: false
    logsource:
      category: file_event
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        TargetFilename|endswith: '.dll'
      condition: selection
    fields:
      - User
      - Image
      - TargetFilename
      - file.path
- question: Were any registry keys related to privilege escalation modified after SharpUp execution?
  context: Detects exploitation of AlwaysInstallElevated, AutoLogon credentials, or Autorun registry keys identified by SharpUp.
  range: +1h
  query: |
    aggregation: false
    logsource:
      category: registry_event
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        TargetObject|contains:
          - '\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated'
          - '\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\AutoAdminLogon'
          - '\Software\Microsoft\Windows\CurrentVersion\Run'
      condition: selection
    fields:
      - User
      - Image
      - TargetObject
      - Details
      - EventType
- question: What network connections were established by SharpUp?
  context: Identifies communication with C2 infrastructure or downloading additional payloads for privilege escalation.
  range: +/-15m
  query: |
    aggregation: false
    logsource:
      category: network_connection
      product: windows
    detection:
      selection:
        ProcessGuid: '{event_data.process.entity_id}'
      condition: selection
    fields:
      - User
      - Image
      - DestinationIp
      - DestinationPort
      - SourceIp
- question: Were any scheduled tasks modified or created after SharpUp enumeration?
  context: SharpUp identifies modifiable scheduled tasks that can be exploited for privilege escalation.
  range: +2h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        Image|endswith: '\schtasks.exe'
        CommandLine|contains:
          - '/Create'
          - '/Change'
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - ProcessId
- question: Is SharpUp execution typical for this user account in the past 30 days?
  context: Distinguishes authorized security testing from unauthorized privilege escalation attempts.
  range: -30d
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        User: '{event_data.user.name}'
        Image|contains: '\SharpUp.exe'
      filter:
        ProcessGuid: '{event_data.process.entity_id}'
      condition: selection and not filter
    fields:
      - hostname
      - Image
      - CommandLine
      - ProcessId
- question: What other hosts on the network have executed SharpUp in the past 24 hours?
  context: Reveals scope of privilege escalation reconnaissance across multiple systems.
  range: -24h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        Image|contains: '\SharpUp.exe'
      filter:
        hostname: '{event_data.host.name}'
      condition: selection and not filter
    fields:
      - User
      - hostname
      - CommandLine
      - ProcessId
- question: Did the same user account execute SharpUp on other hosts in the past 7 days?
  context: Tracks lateral movement and privilege escalation patterns across the network.
  range: -7d
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        User: '{event_data.user.name}'
        Image|contains: '\SharpUp.exe'
      filter:
        hostname: '{event_data.host.name}'
      condition: selection and not filter
    fields:
      - hostname
      - CommandLine
      - ProcessId
- question: Were any Group Policy Preference XML files accessed around SharpUp execution?
  context: SharpUp searches for cached GPP passwords in Groups.xml and other Group Policy files.
  range: +/-30m
  query: |
    aggregation: false
    logsource:
      category: file_event
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        TargetFilename|contains:
          - '\SYSVOL\'
          - '\PolicyDefinitions\'
          - 'Groups.xml'
          - 'Services.xml'
          - 'Scheduledtasks.xml'
      condition: selection
    fields:
      - User
      - Image
      - TargetFilename
      - file.path
- question: Were any unattended installation files accessed around SharpUp execution?
  context: SharpUp searches for unattended installation files containing cleartext credentials in unattend.xml and sysprep files.
  range: +/-30m
  query: |
    aggregation: false
    logsource:
      category: file_event
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        TargetFilename|contains:
          - 'unattend.xml'
          - 'sysprep'
          - 'autounattend.xml'
      condition: selection
    fields:
      - User
      - Image
      - TargetFilename
      - file.path
- question: Were any other privilege escalation or enumeration tools executed on this host within 30 minutes?
  context: Detects concurrent use of multiple privilege escalation tools in coordinated post-exploitation.
  range: +/-30m
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        Image|contains:
          - 'PowerUp'
          - 'Seatbelt'
          - 'Sherlock'
          - 'Watson'
          - 'WinPEAS'
      filter:
        ProcessGuid: '{event_data.process.entity_id}'
      condition: selection and not filter
    fields:
      - User
      - Image
      - CommandLine
      - ProcessId

name: PowerShell Get-Process LSASS
id: 0
description: This detection identifies PowerShell execution of Get-Process commands specifically targeting the LSASS (Local Security Authority Subsystem Service) process. The rule triggers on various Get-Process cmdlet aliases (Get-Process, ps, gps) when used to enumerate the LSASS process, which manages authentication and maintains security tokens on Windows systems. While legitimate administrative scripts may occasionally query LSASS status, this activity pattern frequently precedes credential harvesting techniques and warrants investigation to determine intent and context.
type: detection
detection_id: b2815d0d-7481-4bf0-9b6c-a4c48a94b349
detection_category: Sigma
detection_type: host
contributors:
    - SecurityOnionSolutions
created: "2025-09-29"
questions:
    - question_id: PROC007
      question: Were there any other processes or tools attempting to access LSASS or credential stores alongside the Get-Process command?
      context: LSASS process enumeration often precedes credential extraction attempts, indicating potential credential harvesting activities.
      range: +/-30m
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                TargetImage|endswith: \lsass.exe
                event.outcome: failure
                hostname: '{event_data.host.name}'
        fields:
            - SourceImage
            - TargetImage
            - GrantedAccess
        logsource:
            category: process_access
    - question_id: PROC004
      question: What were the exact PowerShell command line arguments used with the Get-Process cmdlet targeting LSASS?
      context: The specific Get-Process syntax (Get-Process lsass, ps lsass, or gps lsass) reveals the level of PowerShell knowledge and potential automation.
      range: +/-15m
      query:
        aggregation: false
        detection:
            condition: selection or parent
            parent:
                ParentProcessGuid: '{event_data.process.entity_id}'
            selection:
                ProcessGuid: '{event_data.process.entity_id}'
        fields:
            - Image
            - CommandLine
            - User
            - ParentImage
            - ProcessGuid
        logsource:
            category: process_creation
    - question_id: PROC013
      question: What process spawned the PowerShell session that executed the Get-Process LSASS command?
      context: Understanding the parent process helps determine if the PowerShell execution originated from legitimate administrative tools or suspicious sources.
      range: +/-1h
      query:
        aggregation: false
        detection:
            condition: selection or parent
            parent:
                ParentProcessGuid: '{event_data.process.entity_id}'
            selection:
                ProcessGuid: '{event_data.process.entity_id}'
        fields:
            - Image
            - ParentImage
            - CommandLine
        logsource:
            category: process_creation
    - question_id: PS001
      question: What other PowerShell commands were executed in the same session as the Get-Process LSASS command?
      context: Additional PowerShell activity reveals whether LSASS enumeration was part of a larger credential harvesting or reconnaissance script.
      range: +/-30m
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                Image|endswith:
                    - \powershell.exe
                    - \pwsh.exe
                hostname: '{event_data.host.name}'
        fields:
            - CommandLine
            - User
            - ProcessGuid
            - ParentImage
        logsource:
            category: process_creation
    - question_id: PS002
      question: Was the Get-Process LSASS command part of an encoded or obfuscated PowerShell script?
      context: Obfuscated PowerShell containing LSASS enumeration suggests deliberate evasion techniques and non-administrative intent.
      range: +/-30m
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                Image|endswith:
                    - \powershell.exe
                    - \pwsh.exe
                hostname: '{event_data.host.name}'
        fields:
            - CommandLine
            - User
            - ProcessGuid
            - ParentImage
        logsource:
            category: process_creation
    - question_id: PS004
      question: What PowerShell script block content was captured that includes the Get-Process LSASS execution?
      context: Script block logging reveals the full context of LSASS enumeration within larger PowerShell operations or scripts.
      range: +/-30m
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                EventID: 4104
                hostname: '{event_data.host.name}'
        fields:
            - ScriptBlockText
            - Path
            - User
            - ProcessId
        logsource:
            definition: Microsoft-Windows-PowerShell/Operational
            service: powershell
    - question_id: USER001
      question: What user account and privilege level was used to execute the Get-Process LSASS command?
      context: User context and privileges help determine if LSASS enumeration aligns with legitimate administrative responsibilities.
      range: "0"
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                ProcessGuid: '{event_data.process.entity_id}'
                hostname: '{event_data.host.name}'
        fields:
            - ProcessGuid
            - ParentProcessGuid
            - Image
            - CommandLine
            - timestamp
        logsource:
            category: process_creation
    - question_id: HIST001
      question: How frequently does this user or host execute Get-Process commands targeting LSASS?
      context: Baseline analysis helps distinguish between routine administrative LSASS monitoring and unusual enumeration activity.
      range: -90d
      query:
        aggregation: true
        detection:
            condition: selection
            selection:
                User: '{event_data.user.name}'
                hostname: '{event_data.host.name}'
        fields:
            - Image
            - User
            - CommandLine
        logsource:
            category: process_creation
    - question_id: NET002
      question: What DNS queries were made by this host around the time of the Get-Process LSASS execution?
      context: DNS activity patterns can indicate if LSASS enumeration was followed by external communications or tool downloads.
      range: +/-30m
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                hostname: '{event_data.host.name}'
        fields:
            - dns.query.name
            - dns.resolved_ip
            - process.name
            - timestamp
        logsource:
            category: dns
    - question_id: UNI001
      question: What network connections were established before or after the Get-Process LSASS command execution?
      context: Network activity correlation helps determine if LSASS enumeration was part of remote access sessions or data exfiltration attempts.
      range: +/-30m
      query:
        aggregation: false
        detection:
            condition: selection and filter
            filter:
                hostname: '{event_data.host.name}'
            selection: null
        fields:
            - process.name
            - process.pid
            - process.command_line
            - dst_ip
            - dst_port
        logsource:
            category: network
            product: windows
    - question_id: HUNT001
      question: Have other hosts in the environment executed similar Get-Process LSASS commands recently?
      context: Cross-system analysis reveals whether LSASS enumeration represents isolated activity or part of broader reconnaissance efforts.
      range: -7d
      query:
        aggregation: true
        detection:
            condition: selection and not host_filter
            host_filter:
                hostname: '{event_data.host.name}'
            selection:
                dst_ip: '{destination.ip}'
                rule.category|contains:
                    - MALWARE
                    - C2
                    - EXPLOIT
                src_ip: '{source.ip}'
        fields:
            - hostname
            - src_ip
            - dst_ip
            - rule.name
            - rule.category
        logsource:
            category: alert
    - question_id: PROC021
      question: Did the PowerShell process that executed Get-Process LSASS spawn any additional processes or tools?
      context: Child process analysis reveals if LSASS enumeration was followed by credential dumping tools or other post-enumeration activities.
      range: +5m
      query:
        aggregation: false
        detection:
            condition: selection or parent
            parent:
                ParentProcessGuid: '{event_data.process.entity_id}'
            selection:
                ProcessGuid: '{event_data.process.entity_id}'
        fields:
            - Image
            - CommandLine
        logsource:
            category: process_creation

name: Suspicious PowerShell Mailbox Export to Share
id: 1500070
description: |
  Detects execution of the New-MailboxExportRequest PowerShell cmdlet to export mailbox data to a remote or local
  share, a technique observed in ProxyShell exploitation campaigns. This cmdlet allows exporting entire mailboxes
  or specific folders to PST files, which can be stored on UNC paths accessible to remote systems. The technique
  was prominently used following ProxyShell exploitation (CVE-2021-34473, CVE-2021-34523, CVE-2021-31207) to
  exfiltrate email data from compromised Exchange servers. The command requires Exchange Management Shell permissions
  and is typically executed post-exploitation to steal confidential email communications. Detection focuses on
  mailbox export operations targeting UNC paths, which indicate potential data exfiltration to external locations.
type: detection
detection_id: 889719ef-dd62-43df-86c3-768fb08dc7c0
detection_category: ''
detection_type: sigma
contributors:
- SecurityOnionSolutions
created: 2025-01-15
questions:
- question: What was the full New-MailboxExportRequest command executed on this Exchange server?
  context: Identifies the specific mailbox targeted for export, the destination share path, and any filter parameters.
  range: +/-5m
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        ProcessGuid: '{event_data.process.entity_id}'
      condition: selection
    fields:
      - User
      - hostname
      - Image
      - CommandLine
      - ParentImage
- question: What process initiated the PowerShell execution that ran the mailbox export command?
  context: Determines if the export was initiated by an administrative console, remote execution tool, or exploit framework.
  range: -15m
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        ProcessGuid: '{event_data.process.parent.entity_id}'
      condition: selection
    fields:
      - User
      - hostname
      - Image
      - CommandLine
      - ParentImage
- question: What mailbox was targeted for export in the New-MailboxExportRequest command?
  context: Reveals which user's email data was selected for exfiltration.
  range: +/-5m
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        ProcessGuid: '{event_data.process.entity_id}'
        CommandLine|contains:
          - 'New-MailboxExportRequest'
          - '-Mailbox'
      condition: selection
    fields:
      - User
      - CommandLine
- question: What UNC path was specified as the destination for the mailbox export?
  context: Identifies the remote share or network location where exfiltrated mailbox data was written.
  range: +/-5m
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        ProcessGuid: '{event_data.process.entity_id}'
        CommandLine|contains:
          - '-FilePath'
          - '\\\\'
      condition: selection
    fields:
      - CommandLine
- question: Have multiple mailbox export operations been executed on this Exchange server?
  context: Determines if this is part of a sustained data exfiltration campaign targeting multiple users.
  range: +/-24h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        CommandLine|contains:
          - 'New-MailboxExportRequest'
          - '-FilePath'
          - '\\\\'
      filter:
        ProcessGuid: '{event_data.process.entity_id}'
      condition: selection and not filter
    fields:
      - User
      - CommandLine
- question: Was there ProxyShell exploitation activity prior to the mailbox export operation?
  context: ProxyShell (CVE-2021-34473, CVE-2021-34523) enables pre-auth RCE and is commonly chained with mailbox exports.
  range: -1h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        CommandLine|contains:
          - 'proxyShell'
          - 'autodiscover.json'
          - 'powershell.exe@'
          - 'Email=autodiscover'
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - ParentImage
- question: Were web shells or suspicious files written to Exchange directories before the mailbox export?
  context: ProxyShell exploitation often involves writing web shells to Exchange OAB or aspnet_client directories.
  range: -2h
  query: |
    aggregation: false
    logsource:
      category: file_event
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        TargetFilename|contains:
          - '\inetpub\wwwroot\aspnet_client\'
          - '\FrontEnd\HttpProxy\owa\auth\'
          - '\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\ecp\auth\'
        TargetFilename|endswith:
          - '.aspx'
          - '.ashx'
          - '.asmx'
      condition: selection
    fields:
      - User
      - Image
      - TargetFilename
      - ProcessGuid
- question: What network connections were made to the destination UNC path share?
  context: Identifies the remote server or network location receiving the exfiltrated mailbox data.
  range: +2h
  query: |
    aggregation: false
    logsource:
      category: network_connection
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        DestinationPort:
          - 445
          - 139
      condition: selection
    fields:
      - User
      - Image
      - DestinationIp
      - DestinationPort
      - ProcessGuid
- question: Were there other Exchange Management Shell commands executed around the time of the mailbox export?
  context: Identifies additional Exchange operations such as role assignment changes or mailbox access permissions.
  range: +/-1h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        Image|endswith:
          - '\powershell.exe'
          - '\pwsh.exe'
        CommandLine|contains:
          - 'Get-Mailbox'
          - 'Add-MailboxPermission'
          - 'New-ManagementRoleAssignment'
          - 'Set-User'
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - ParentImage
- question: Did w3wp.exe spawn PowerShell processes prior to the mailbox export operation?
  context: IIS worker process spawning PowerShell indicates web-based exploitation such as ProxyShell or web shell execution.
  range: -30m
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        ParentImage|endswith: '\w3wp.exe'
        Image|endswith:
          - '\powershell.exe'
          - '\pwsh.exe'
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - ParentImage
- question: Were PST files created or written to disk during or after the mailbox export?
  context: The New-MailboxExportRequest command creates PST files containing exported mailbox data.
  range: +2h
  query: |
    aggregation: false
    logsource:
      category: file_event
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        TargetFilename|endswith: '.pst'
      condition: selection
    fields:
      - User
      - Image
      - TargetFilename
      - ProcessGuid
- question: Have other Exchange servers in the environment experienced similar mailbox export operations?
  context: Reveals campaign-wide data exfiltration efforts targeting multiple Exchange servers.
  range: +/-24h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        CommandLine|contains:
          - 'New-MailboxExportRequest'
          - '-FilePath'
          - '\\\\'
      filter:
        hostname: '{event_data.host.name}'
      condition: selection and not filter
    fields:
      - hostname
      - User
      - CommandLine
- question: Did the same user account execute mailbox exports on other hosts in the environment?
  context: Tracks cross-host activity to determine if compromised credentials are being used for widespread exfiltration.
  range: +/-24h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        User: '{event_data.user.name}'
        CommandLine|contains:
          - 'New-MailboxExportRequest'
          - '-FilePath'
      filter:
        hostname: '{event_data.host.name}'
      condition: selection and not filter
    fields:
      - hostname
      - CommandLine
- question: Were there authentication events or logon activities from external IP addresses prior to the mailbox export?
  context: ProxyShell exploitation enables pre-authentication access, followed by mailbox exfiltration operations.
  range: -1h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        Image|endswith:
          - '\powershell.exe'
          - '\pwsh.exe'
        CommandLine|contains:
          - 'http'
          - 'Invoke-WebRequest'
          - 'DownloadString'
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - ParentImage
- question: Are there signs of lateral movement or credential reuse after the mailbox export operation?
  context: Identifies follow-on activity leveraging compromised Exchange credentials for lateral movement.
  range: +2h
  query: |
    aggregation: false
    logsource:
      category: process_creation
      product: windows
    detection:
      selection:
        hostname: '{event_data.host.name}'
        Image|endswith:
          - '\psexec.exe'
          - '\wmic.exe'
          - '\net.exe'
          - '\net1.exe'
      condition: selection
    fields:
      - User
      - Image
      - CommandLine
      - ParentImage

name: File In Suspicious Location Encoded To Base64 Via Certutil.EXE
id: 100
description: This detection identified the use of certutil.exe with the -encode flag to convert files to base64 format, where the source files were located in potentially suspicious directories such as temp folders, desktop, or user profile areas. The certutil utility, while legitimate, is commonly used for defense evasion techniques to obfuscate file content and bypass security controls. Investigation should focus on determining the legitimacy of the encoding operation and whether it represents normal administrative activity or unauthorized data processing.
type: detection
detection_id: 82a6714f-4899-4f16-9c1e-9a333544d4c3
detection_category: ''
detection_type: sigma
contributors:
    - SecurityOnionSolutions
created: "2025-09-29T00:00:00Z"
questions:
    - question_id: PROC020
      question: What was the full certutil.exe command line including the -encode flag and file path parameters?
      context: Complete certutil command reveals specific encoding targets, suspicious file locations, and potential data obfuscation objectives
      range: ""
      query:
        aggregation: false
        detection:
            condition: selection or parent
            parent:
                ParentProcessGuid: '{event_data.process.entity_id}'
            selection:
                ProcessGuid: '{event_data.process.entity_id}'
        fields:
            - Image
            - CommandLine
        logsource:
            category: process_creation
    - question_id: PROC013
      question: What process initiated the certutil.exe encoding operation and what was the execution chain?
      context: Parent process context helps determine if certutil encoding was part of legitimate system administration or unauthorized activity
      range: +/-1h
      query:
        aggregation: false
        detection:
            condition: selection or parent
            parent:
                ParentProcessGuid: '{event_data.process.entity_id}'
            selection:
                ProcessGuid: '{event_data.process.entity_id}'
        fields:
            - Image
            - ParentImage
            - CommandLine
        logsource:
            category: process_creation
    - question_id: PROC021
      question: Did the certutil.exe process spawn any child processes after encoding the file?
      context: Post-encoding process activity reveals whether encoded content was immediately processed or transferred
      range: +5m
      query:
        aggregation: false
        detection:
            condition: selection or parent
            parent:
                ParentProcessGuid: '{event_data.process.entity_id}'
            selection:
                ProcessGuid: '{event_data.process.entity_id}'
        fields:
            - Image
            - CommandLine
        logsource:
            category: process_creation
    - question_id: FILE006
      question: Were base64-encoded files created in suspicious locations like AppData, Temp, or Desktop directories?
      context: Base64 output file locations and naming patterns indicate potential data staging or evasion techniques
      range: +/-1h
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                TargetFilename|endswith:
                    - .zip
                    - .rar
                    - .7z
                    - .tar
                    - .gz
                hostname: '{event_data.host.name}'
        fields:
            - TargetFilename
            - Image
            - User
            - ProcessGuid
            - file.size
        logsource:
            category: file_event
    - question_id: FILE009
      question: What are the hash values and properties of both the source file and resulting base64-encoded output?
      context: File analysis enables identification of encoded content type and correlation with known threat indicators
      range: -10m
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                TargetFilename: '{event_data.process.executable}'
                hostname: '{event_data.host.name}'
        fields:
            - TargetFilename
            - Hashes
            - Signed
            - SignatureStatus
            - Subject
        logsource:
            category: file_event
    - question_id: PROC008
      question: Was the certutil.exe -encode operation part of a script or batch file execution?
      context: Automated encoding operations may indicate systematic data processing or evasion workflows
      range: +/-15m
      query: obfuscated_command_analysis
    - question_id: NET002
      question: What DNS queries occurred around the time of the certutil encoding activity?
      context: Network resolution patterns may reveal preparation for data transfer or communication with external infrastructure
      range: +/-30m
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                hostname: '{event_data.host.name}'
        fields:
            - dns.query.name
            - dns.resolved_ip
            - process.name
            - timestamp
        logsource:
            category: dns
    - question_id: UNI001
      question: What network connections were established before or after the certutil base64 encoding operation?
      context: Network activity context determines if encoded files were transmitted externally or processed locally
      range: +/-30m
      query:
        aggregation: false
        detection:
            condition: selection and filter
            filter:
                hostname: '{event_data.host.name}'
            selection: null
        fields:
            - process.name
            - process.pid
            - process.command_line
            - dst_ip
            - dst_port
        logsource:
            category: network
            product: windows
    - question_id: STAG001
      question: What other executables or files were present in the same directories where base64 encoding occurred?
      context: Co-located files may indicate staging areas or reveal the broader scope of file processing operations
      range: +/-20m
      query: tool_staging_analysis
    - question_id: HIST001
      question: What is the historical pattern of certutil -encode usage by this user and system?
      context: Baseline encoding activity helps distinguish routine administrative tasks from unusual data processing behavior
      range: -90d
      query:
        aggregation: true
        detection:
            condition: selection
            selection:
                User: '{event_data.user.name}'
                hostname: '{event_data.host.name}'
        fields:
            - Image
            - User
            - CommandLine
        logsource:
            category: process_creation
    - question_id: HUNT004
      question: Have other systems performed certutil base64 encoding of files in similar suspicious locations recently?
      context: Cross-system encoding patterns may indicate coordinated operations or common administrative procedures
      range: -24h
      query:
        aggregation: false
        detection:
            condition: selection and not host_filter
            filter:
                hostname: '{event_data.host.name}'
            host_filter:
                hostname: '{event_data.host.name}'
            selection: null
        fields:
            - Image
            - CommandLine
            - User
            - ParentImage
            - ProcessGuid
        logsource:
            category: process_creation
    - question_id: REG003
      question: Were any registry modifications made in conjunction with the certutil encoding activity?
      context: Registry changes concurrent with file encoding may indicate configuration of persistence or evasion mechanisms
      range: +/-2h
      query:
        aggregation: false
        detection:
            condition: selection
            selection:
                TargetObject|contains:
                    - Run
                    - RunOnce
                    - Services
                    - Winlogon
                    - Shell
                    - AppInit_DLLs
                hostname: '{event_data.host.name}'
        fields:
            - TargetObject
            - Details
            - Image
            - User
            - ProcessGuid
        logsource:
            category: registry_event
